######ç†è§£æœ¬ç¯‡å†…å®¹éœ€æŽŒæ¡ä¸€ç‚¹OpenGLåŸºç¡€ï¼š
1.glProgramçš„ç¼–è¯‘ï¼Œé“¾æŽ¥ï¼Œä½¿ç”¨ã€‚
2.glFramebufferä¸ŽglTextureçš„ä½¿ç”¨ã€‚

###ç®€è¿°
GPUImageæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªOpenGLç®¡ç†æ¡†æž¶ï¼Œå…¶ä¸ä»…åŒ…å«å¤§é‡çš„æ»¤é•œä»£ç ï¼Œä¹ŸåŒ…å«ä¸€å¥—ä½¿ç”¨æ–¹ä¾¿çš„é“¾å¼ç»“æž„ï¼Œæœ¬ç¯‡å°†ä¸»è¦åˆ†æžæ»¤é•œé“¾çš„åŽŸç†ã€‚

å¦‚æžœå°†è¿™ä¸ªé“¾å¼ç»“æž„æ¯”å–»ä¸ºä¸€ä¸ªå·¥åŽ‚ä¸­çš„æµæ°´çº¿ï¼Œé‚£ä¹ˆè¿™ä¸ªæµæ°´çº¿çš„ç»“æž„å°±ä¼šå¦‚ä¸‹æ‰€ç¤ºï¼š
1.æ€»èµ„æºç®¡ç†è€… 
```
GPUImageContext
```
2.æ­è½½åŽŸæ–™çš„å®¹å™¨
```
GPUImageFramebuffer
```
3.åŽŸæ–™æä¾›è€…
```
GPUImagePictureï¼ŒGPUImageMovie...
```
4.åŽŸæ–™åŠ å·¥è€…
```
GPUImageFilter
```
5.æˆå“å±•ç¤ºè€…
```
GPUImageView
```
6.åŽŸæ–™å®¹å™¨æ•°é‡çš„æŽ§åˆ¶è€…
```
GPUImageFramebufferCache
```
ä¸‹é¢å°†ä¾æ¬¡ä»‹ç»è¿™äº›éƒ¨åˆ†åœ¨æ»¤é•œé“¾ä¸­çš„è¯¦ç»†ä½œç”¨

#####GPUImageContext
ä½œä¸ºæ€»èµ„æºç®¡ç†è€…ï¼Œä»¥å•ä¾‹æ–¹å¼åº”ç”¨ï¼Œä¸»è¦è´Ÿè´£ï¼š
1.çº¿ç¨‹ç®¡ç†
2.context
3.framebufferç¼“å­˜ç®¡ç†
4.glä¿¡æ¯æŸ¥è¯¢
#####GPUImageFramebuffer
ä½œä¸ºåŽŸæ–™çš„å®¹å™¨ï¼Œä¹Ÿæ˜¯æ»¤é•œé“¾ä¼ é€’çš„**æ ¸å¿ƒ**ã€‚ä½†ä¹‹æ‰€ä»¥ç§°ä¹‹ä¸º**å®¹å™¨**ï¼Œæ˜¯å› ä¸ºæ¯ä¸€çº§æ‰€éœ€è¦çš„çœŸæ­£ææ–™ä¸æ˜¯GPUImageFramebufferï¼Œè€Œæ˜¯é‡Œé¢çš„**glTexture**ã€‚

GPUImageFramebufferåŒ…å«ä¸¤ç§ç±»åž‹

1.**onlyTexture**ï¼šåªç”Ÿæˆäº†glTextureè€Œæ²¡æœ‰ç”ŸæˆglFramebufferï¼Œå¤šç”¨äºŽ**ç¬¬ä¸€çº§è¾“å…¥ç«¯**ï¼Œä¾‹å¦‚GPUImagePictureã€‚

2.**textureå’Œframebuffer**ï¼šç”Ÿæˆäº†glTextureï¼Œä¹Ÿç”Ÿæˆäº†glFramebufferï¼Œå¹¶ä½¿ç”¨ **glFramebufferTexture2D** å°†äºŒè€…ç»‘å®šï¼Œç”¨äºŽæ»¤é•œçš„æ¸²æŸ“ä¸­ï¼Œå¦‚GPUImageFilterã€‚

GPUImageFramebufferä¼ é€’çš„**æ ¸å¿ƒåŽŸç†ï¼š**
å½“å‰æ»¤é•œåœ¨æ¸²æŸ“æ—¶ï¼Œå…ˆç»‘å®šåˆ°è‡ªå·±çš„glFramebufferï¼Œç„¶åŽèŽ·å–ä¸Šä¸€çº§æ»¤é•œGPUImageFramebufferä¸­çš„glTextureä½œä¸º**è¾“å…¥**çº¹ç†ï¼Œé€šè¿‡æ¯ä¸ªæ»¤é•œç‰¹æœ‰çš„glProgramï¼Œå¯¹å½“å‰æ»¤é•œçš„**è¾“å‡º**glTextureè¿›è¡Œæ¸²æŸ“

#####GPUImagePictureï¼ŒGPUImageMovie...
ä½œä¸ºåŽŸæ–™æä¾›è€…ï¼Œå¤„äºŽæ»¤é•œé“¾çš„å¤´éƒ¨ï¼Œé€šè¿‡ç»§æ‰¿GPUImageOutputæ¥å®žçŽ°**GPUImageFramebuffer**çš„è¾“å‡ºã€‚æœ¬è´¨ä¸Šæ˜¯å°†æ•°æ®è½¬åŒ–ä¸ºOpenGLè¯†åˆ«çš„çº¹ç†ã€‚

#####GPUImageFilter
ä½œä¸ºåŽŸæ–™åŠ å·¥è€…ï¼Œå¤„äºŽæ»¤é•œé“¾çš„ä¸­æ®µï¼Œæ—¢ç»§æ‰¿äº†**GPUImageOutput**ï¼Œåˆå®žçŽ°äº†**GPUImageInput**åè®®ã€‚ï¼ˆæ— è®ºæ˜¯Outputè¿˜æ˜¯Inputéƒ½æ˜¯å¯¹äºŽGPUImageFramebufferè€Œè¨€ï¼‰

è¿™æ ·ä¾¿å½¢æˆäº†ä»¥**GPUImageFramebuffer**ä¸ºä¼ é€’è€…çš„é“¾å¼ç»“æž„ã€‚

è€Œä¸”åŒä¸€ä¸ªæ»¤é•œå¯ä»¥å­˜åœ¨äºŽå¤šæ¡æ»¤é•œé“¾ä¸­ã€‚

ä»¥ä¸‹ä»£ç å±•ç¤ºçš„æ˜¯ä¸€ä¸ªç®€å•çš„æ»¤é•œé“¾ï¼Œé€šè¿‡æ•ˆæžœå¯ä»¥çœ‹å‡ºæ¯ä¸€ä¸ªfilterå¤„ç†çº¹ç†å›¾ç‰‡çš„è¿‡ç¨‹ï¼š
```
[picture addTarget:filter1];    

[filter1 addTarget:filter2];
[filter1 addTarget:imageView1];

[filter2 addTarget:imageView2];
[filter2 addTarget:filter3];
    
[filter3 addTarget:imageView3];
[picture processImage]; 
```
![ðŸ·](https://upload-images.jianshu.io/upload_images/2148470-2066d7aa8bd44dff.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

#####GPUImageView
ä½œä¸ºæˆå“å±•ç¤ºè€…ï¼Œå¤„äºŽæ»¤é•œé“¾çš„æœ€æœ«ç«¯ï¼ŒåªæŽ¥å—çº¹ç†ï¼Œä¸å†è¿›è¡Œè¾“å‡ºã€‚
å®žçŽ°**GPUImageInput**åè®®ï¼ŒåªæŽ¥å—ä¸Šçº§æ»¤é•œä¼ æ¥çš„çº¹ç†ï¼Œè€Œç”¨äºŽå±•ç¤ºçš„glFramebuffer**ä¸å†ä½¿ç”¨**GPUImageFramebufferï¼Œè€Œç›´æŽ¥ç”±è‡ªå·±ç”Ÿæˆç»‘å®šäºŽ**glRenderbuffer**çš„glFramebufferã€‚

#####GPUImageFramebufferCache
ä½œä¸ºåŽŸæ–™å®¹å™¨çš„ç®¡ç†è€…ï¼ŒGPUImageFramebufferCacheä½¿GPUImageFramebufferå¾—ä»¥å¤ç”¨ï¼Œç›®çš„æ˜¯æå‡æ€§èƒ½ï¼Œå°±åƒæ²¡å¿…è¦ç»™æ¯é“èœéƒ½ä½¿ç”¨æ–°çš„ç›˜å­ä¸€æ ·ã€‚

**ç¼“å­˜æ­¥éª¤ï¼š**
1.**åŒºåˆ†ç¼“å­˜ç±»åž‹**
ä¿è¯åŒä¸€ç±»åž‹çš„ç¼“å­˜å¯ä»¥å¤ç”¨ï¼Œå…·ä½“å°±æ˜¯æ ¹æ®ä¸åŒçš„GPUImageFramebufferç”Ÿæˆä¸åŒçš„keyï¼Œä¸»è¦ä»¥çº¹ç†é…ç½®ï¼Œçº¹ç†å°ºå¯¸ï¼Œä»¥åŠæ˜¯å¦åªåŒ…å«textureä½œä¸ºåˆ†ç±»æ ‡å‡†ï¼Œç»†èŠ‚å¦‚ä¸‹
```
- (NSString *)hashForSize:(CGSize)size textureOptions:(GPUTextureOptions)textureOptions onlyTexture:(BOOL)onlyTexture;
{
    if (onlyTexture)
    {
        return [NSString stringWithFormat:@"%.1fx%.1f-%d:%d:%d:%d:%d:%d:%d-NOFB", size.width, size.height, textureOptions.minFilter, textureOptions.magFilter, textureOptions.wrapS, textureOptions.wrapT, textureOptions.internalFormat, textureOptions.format, textureOptions.type];
    }
    else
    {
        return [NSString stringWithFormat:@"%.1fx%.1f-%d:%d:%d:%d:%d:%d:%d", size.width, size.height, textureOptions.minFilter, textureOptions.magFilter, textureOptions.wrapS, textureOptions.wrapT, textureOptions.internalFormat, textureOptions.format, textureOptions.type];
    }
}
```
2.**å¼•ç”¨è®¡æ•°**
GPUImageFramebufferCacheä½¿ç”¨ç¼“å­˜çš„æ–¹å¼ä¸Žæ™®é€šçš„ç¼“å­˜ä¸å¤ªä¸€æ ·ã€‚

**æ™®é€šç¼“å­˜**ï¼š
1.æŒ‰keyæ‰¾ç¼“å­˜å¯¹è±¡ã€‚
2.æœ‰åˆ™è¿”å›žåŒ¹é…å¯¹è±¡ã€‚
3.æ²¡æœ‰åˆ™åˆ›å»ºæ–°çš„å¯¹è±¡ä¸”å­˜å…¥ç¼“å­˜ï¼Œå¹¶è¿”å›žæ–°å¯¹è±¡ã€‚

**GPUImageFramebufferCache**ï¼š
1.æŒ‰keyæ‰¾ç¼“å­˜å¯¹è±¡ã€‚
2.å¦‚æžœæœ‰ï¼Œåˆ™ä»Žç¼“å­˜ä¸­**ç§»é™¤**å½“å‰åŒ¹é…å¯¹è±¡ï¼Œå¯¹è±¡å¼•ç”¨è®¡æ•°+1ã€‚
3.å¦‚æžœæ²¡æœ‰ï¼Œåˆ™æ–°å»ºå¯¹è±¡ï¼Œè¿™æ—¶å¹¶**ä¸ä¼š**æŠŠæ–°å¯¹è±¡å­˜å…¥ç¼“å­˜ï¼Œåªæ˜¯å¯¹æ–°å¯¹è±¡å¼•ç”¨è®¡æ•°+1ã€‚

è¿™ç§ç¼“å­˜æœ‰ç‚¹ç±»ä¼¼äºŽARCæœºåˆ¶ï¼Œå°†è¦æ¸²æŸ“æ—¶ï¼Œåˆ™å¯¹å½“å‰GPUImageFramebufferè°ƒç”¨**lock**æ–¹æ³•ï¼Œä½¿å…¶å¼•ç”¨è®¡æ•°+1ï¼Œæ¸²æŸ“å®Œæˆæˆ–æ»¤é•œé”€æ¯ç­‰é‡Šæ”¾æ“ä½œåŽï¼Œè°ƒç”¨**unlock**æ–¹æ³•ï¼Œä½¿å…¶å¼•ç”¨è®¡æ•°-1ï¼Œå½“å¼•ç”¨è®¡æ•°ä¸º0æ—¶ï¼Œæ‰å°†å¯¹è±¡æ”¾å…¥ç¼“å­˜å½“ä¸­ã€‚

######ä½¿ç”¨è¿™ç§ç¼“å­˜çš„åŽŸå› 
å½“ä¸€ä¸ªGPUImageFramebufferå¼•ç”¨è®¡æ•°å¤§äºŽ0æ—¶ï¼Œä¸ä¼šå†å°†å®ƒåˆ†é…ç»™å…¶ä»–æ»¤é•œè¿›è¡Œæ¸²æŸ“ï¼Œé¿å…glFramebufferæ•°æ®è¢«ç¯¡æ”¹ã€‚

è€Œå½“ä¸€ä¸ªGPUImageFramebufferå¼•ç”¨è®¡æ•°ä¸º0æ—¶ï¼Œæ‰ä¼šç»§ç»­å°†å®ƒåˆ†é…ç»™å…¶ä»–æ»¤é•œã€‚

ç”±æ­¤å¯ä»¥å¾—çŸ¥ï¼Œå½“ä»Žç¼“å­˜ä¸­è¯·æ±‚GPUImageFramebufferå¯¹è±¡æ—¶ï¼ŒåŒç±»åž‹çš„GPUImageFramebufferå¯¹è±¡ï¼Œå¯èƒ½å› ä¸ºå¼•ç”¨è®¡æ•°å¤§äºŽ0ï¼Œè€Œä¸åœ¨ç¼“å­˜ä¸­ã€‚è¿™æ—¶ä¼š**å†æ¬¡ç”Ÿæˆ**è¿™ä¸ªç±»åž‹çš„ç¼“å­˜å¯¹è±¡ã€‚å½“è¿™å‡ ä¸ªåŒç±»åž‹çš„å¯¹è±¡å¼•ç”¨è®¡æ•°éƒ½å½’0æ—¶ï¼Œä¾¿éƒ½ä¼šå­˜å…¥ç¼“å­˜ã€‚

æ‰€ä»¥GPUImageFramebufferCacheåœ¨**è¯·æ±‚ç¼“å­˜**æ—¶ï¼Œä¼šå…ˆä½¿ç”¨whileå¾ªçŽ¯æ¥æ¸…ç©ºå¤šä½™åŒç±»ç¼“å­˜ï¼Œç»†èŠ‚å¦‚ä¸‹ï¼š
```
// Something found, pull the old framebuffer and decrement the count
            NSInteger currentTextureID = (numberOfMatchingTextures - 1);
            while ((framebufferFromCache == nil) && (currentTextureID >= 0))
            {
                NSString *textureHash = [NSString stringWithFormat:@"%@-%ld", lookupHash, (long)currentTextureID];
                framebufferFromCache = [framebufferCache objectForKey:textureHash];
                // Test the values in the cache first, to see if they got invalidated behind our back
                if (framebufferFromCache != nil)
                {
                    // Withdraw this from the cache while it's in use
                    [framebufferCache removeObjectForKey:textureHash];
                }
                currentTextureID--;
            }
```
